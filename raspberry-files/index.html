<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
        }
        #videoPlayer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: contain;
            background: #000;
        }
        #controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            display: none;
        }
        #debugInfo {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .online {
            background: #4CAF50;
        }
        .offline {
            background: #f44336;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            margin: 0 5px;
        }
        button:hover {
            background: #1976D2;
        }
        .status-text {
            color: white;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div id="debugInfo"></div>
    <div id="controls">
        <span class="status-indicator"></span>
        <span class="status-text">Offline</span>
        <button onclick="restartBrowser()">Restart Browser</button>
    </div>
    <video id="videoPlayer" 
           autoplay 
           loop 
           muted 
           playsinline></video>

    <script src="config.js"></script>
    <script>
        const videoPlayer = document.getElementById('videoPlayer');
        const debugInfo = document.getElementById('debugInfo');
        const controls = document.getElementById('controls');
        const statusIndicator = document.querySelector('.status-indicator');
        const statusText = document.querySelector('.status-text');
        let isOnline = false;

        // Simple error logging
        function log(msg) {
            console.log(msg);
            if (debugInfo.style.display === 'none') {
                debugInfo.style.display = 'block';
                setTimeout(() => { debugInfo.style.display = 'none'; }, 5000);
            }
            debugInfo.textContent = msg + '\n' + debugInfo.textContent;
        }

        // Update online status
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            statusIndicator.className = 'status-indicator ' + (isOnline ? 'online' : 'offline');
            statusText.textContent = isOnline ? 'Online' : 'Offline';
            reportStatus();
        }

        // Report status to server
        async function reportStatus() {
            if (!isOnline) return;
            
            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.STATUS}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.API_KEY}`,
                        'X-Device-Id': API_CONFIG.DEVICE_ID
                    },
                    body: JSON.stringify({
                        status: 'active',
                        video_time: videoPlayer.currentTime,
                        total_time: videoPlayer.duration,
                        is_playing: !videoPlayer.paused,
                        timestamp: new Date().toISOString(),
                        version: '1.0.0'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                log('Status reported successfully');
            } catch (error) {
                log('Error reporting status: ' + error.message);
            }
        }

        // Restart browser
        function restartBrowser() {
            if (confirm('Are you sure you want to restart the browser?')) {
                fetch('/restart', { method: 'POST' })
                    .catch(() => {
                        // If fetch fails, try to restart via service worker
                        if ('serviceWorker' in navigator) {
                            navigator.serviceWorker.controller?.postMessage({ type: 'restart' });
                        }
                    });
            }
        }

        // Simple video player
        async function initPlayer() {
            try {
                videoPlayer.src = 'sample.mp4';
                
                videoPlayer.onerror = (e) => {
                    log('Video Error: ' + (videoPlayer.error ? videoPlayer.error.message : 'Unknown error'));
                };
                
                videoPlayer.oncanplay = () => {
                    log('Video ready to play');
                    videoPlayer.play().catch(e => log('Play error: ' + e));
                };
                
                // Monitor performance
                let lastTime = 0;
                videoPlayer.ontimeupdate = () => {
                    if (lastTime > 0) {
                        const diff = videoPlayer.currentTime - lastTime;
                        if (diff > 0.5) {
                            log('Frame skip detected');
                        }
                    }
                    lastTime = videoPlayer.currentTime;
                };
            } catch (e) {
                log('Init error: ' + e);
            }
        }

        // Initialize
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        // Start player
        initPlayer();
        
        // Set up status reporting interval
        setInterval(reportStatus, API_CONFIG.UPDATE_INTERVAL);
        
        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'd') {
                debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
            } else if (e.key === 'c') {
                controls.style.display = controls.style.display === 'none' ? 'block' : 'none';
            }
        });
    </script>
</body>
</html>
