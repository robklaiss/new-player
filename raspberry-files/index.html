<!DOCTYPE html>
<html>
<head>
    <title>Kiosk Video Player</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: black;
            overflow: hidden;
        }
        #videoPlayer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        #debugInfo {
            position: fixed;
            bottom: 10px;
            left: 10px;
            color: rgba(255, 255, 255, 0.5);
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <video id="videoPlayer" autoplay></video>
    <div id="debugInfo"></div>
    <script src="config.js"></script>
    <script src="player.js"></script>
    <script>
        const videoPlayer = document.getElementById('videoPlayer');
        const debugInfo = document.getElementById('debugInfo');
        let isOnline = false;
        let lastStatusUpdate = 0;
        let statusUpdateRetries = 0;
        let lastError = null;

        // Debug logging with timestamp
        function log(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMsg = `[${timestamp}] ${type.toUpperCase()}: ${msg}`;
            console.log(logMsg);
            debugInfo.innerHTML = logMsg + '<br>' + debugInfo.innerHTML;
            debugInfo.style.display = 'block'; // Always show debug during development
        }

        // Update online status
        function updateOnlineStatus() {
            const wasOnline = isOnline;
            isOnline = navigator.onLine;
            
            if (isOnline && !wasOnline) {
                log('Connection restored, reporting status...', 'info');
                reportStatus();
            }
        }

        // Report status to server
        async function reportStatus() {
            if (!isOnline) {
                return;
            }

            try {
                const endpoint = `${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.STATUS}`;
                log(`Reporting status to: ${endpoint}`, 'info');
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.API_KEY}`,
                        'X-Device-Id': API_CONFIG.DEVICE_ID
                    },
                    body: JSON.stringify({
                        status: 'active',
                        video_time: videoPlayer.currentTime || 0,
                        total_time: videoPlayer.duration || 0,
                        is_playing: !videoPlayer.paused,
                        timestamp: new Date().toISOString(),
                        version: '1.0.0',
                        device_id: API_CONFIG.DEVICE_ID,
                        memory_usage: performance.memory ? performance.memory.usedJSHeapSize : 0,
                        last_error: lastError || null
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const data = await response.json();
                log('Status reported successfully', 'success');
                statusUpdateRetries = 0;
                lastStatusUpdate = Date.now();
            } catch (error) {
                log('Error reporting status: ' + error.message, 'error');
                statusUpdateRetries++;
                
                if (statusUpdateRetries >= 3) {
                    log('Connection Failed', 'error');
                }
                
                // Exponential backoff for retries
                const retryDelay = Math.min(1000 * Math.pow(2, statusUpdateRetries), 30000);
                setTimeout(reportStatus, retryDelay);
            }
        }

        // Simple video player
        async function initPlayer() {
            try {
                // Use the configured video path
                const videoUrl = API_CONFIG.LOCAL_VIDEO;
                log(`Loading video: ${videoUrl}`, 'info');
                
                // Load the video
                videoPlayer.src = videoUrl;
                
                // Set up video events
                videoPlayer.onloadeddata = () => {
                    log('Video loaded successfully', 'success');
                    videoPlayer.play()
                        .then(() => log('Video playback started', 'success'))
                        .catch(e => {
                            lastError = e.message;
                            log('Play error: ' + e.message, 'error');
                        });
                };
                
                videoPlayer.onerror = (e) => {
                    lastError = videoPlayer.error ? videoPlayer.error.message : 'Unknown error';
                    log('Video Error: ' + lastError, 'error');
                    // Try to load the video again after error
                    setTimeout(initPlayer, 5000);
                };
            } catch (e) {
                lastError = e.message;
                log('Init error: ' + e.message, 'error');
                // Try to initialize again after error
                setTimeout(initPlayer, 5000);
            }
        }

        // Initialize
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        // Start player
        initPlayer();
        
        // Set up status reporting interval with immediate first report
        reportStatus();
        setInterval(() => {
            if (Date.now() - lastStatusUpdate >= API_CONFIG.UPDATE_INTERVAL) {
                reportStatus();
            }
        }, 5000); // Check every 5 seconds

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'd') {
                debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
            }
        });

        // Prevent white flash during video loops
        videoPlayer.addEventListener('timeupdate', () => {
            if (videoPlayer.currentTime >= videoPlayer.duration - 0.1) {
                videoPlayer.currentTime = 0;
            }
        });

        // Show device ID when not paired
        if (!API_CONFIG.PAIRED) {
            const deviceIdElement = document.createElement('div');
            deviceIdElement.style.position = 'fixed';
            deviceIdElement.style.top = '10px';
            deviceIdElement.style.left = '10px';
            deviceIdElement.style.color = 'white';
            deviceIdElement.style.fontSize = '24px';
            deviceIdElement.style.fontWeight = 'bold';
            deviceIdElement.textContent = `Device ID: ${API_CONFIG.DEVICE_ID}`;
            document.body.appendChild(deviceIdElement);
        }
    </script>
</body>
</html>
