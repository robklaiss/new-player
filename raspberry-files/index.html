<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiosk Player</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
        }
        #video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <div id="video-container">
        <video id="player" autoplay></video>
    </div>
    <script src="config.js"></script>
    <script src="service-worker.js"></script>
    <script>
        const videoPlayer = document.getElementById('player');
        const debugInfo = document.getElementById('debugInfo');
        const controls = document.getElementById('controls');
        const statusIndicator = document.querySelector('.status-indicator');
        const statusText = document.querySelector('.status-text');
        let isOnline = false;
        let lastStatusUpdate = 0;
        let statusUpdateRetries = 0;
        let lastError = null;

        // Debug logging with timestamp
        function log(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMsg = `[${timestamp}] ${type.toUpperCase()}: ${msg}`;
            console.log(logMsg);
            debugInfo.innerHTML = logMsg + '<br>' + debugInfo.innerHTML;
            debugInfo.style.display = 'block'; // Always show debug during development
        }

        // Update online status
        function updateOnlineStatus() {
            const wasOnline = isOnline;
            isOnline = navigator.onLine;
            statusIndicator.className = 'status-indicator ' + (isOnline ? 'online' : 'offline');
            statusText.textContent = isOnline ? 'Online' : 'Offline';
            
            if (isOnline && !wasOnline) {
                log('Connection restored, reporting status...', 'info');
                reportStatus();
            }
        }

        // Report status to server
        async function reportStatus() {
            if (!isOnline) {
                statusIndicator.className = 'status-indicator offline';
                statusText.textContent = 'Offline';
                return;
            }

            statusIndicator.className = 'status-indicator connecting';
            statusText.textContent = 'Connecting...';
            
            try {
                const endpoint = `${API_CONFIG.BASE_URL}${API_CONFIG.ENDPOINTS.STATUS}`;
                log(`Reporting status to: ${endpoint}`, 'info');
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.API_KEY}`,
                        'X-Device-Id': API_CONFIG.DEVICE_ID
                    },
                    body: JSON.stringify({
                        status: 'active',
                        video_time: videoPlayer.currentTime || 0,
                        total_time: videoPlayer.duration || 0,
                        is_playing: !videoPlayer.paused,
                        timestamp: new Date().toISOString(),
                        version: '1.0.0',
                        device_id: API_CONFIG.DEVICE_ID,
                        memory_usage: performance.memory ? performance.memory.usedJSHeapSize : 0,
                        last_error: lastError || null
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const data = await response.json();
                log('Status reported successfully', 'success');
                statusUpdateRetries = 0;
                lastStatusUpdate = Date.now();
                
                statusIndicator.className = 'status-indicator online';
                statusText.textContent = 'Connected';
            } catch (error) {
                log('Error reporting status: ' + error.message, 'error');
                statusUpdateRetries++;
                
                if (statusUpdateRetries >= 3) {
                    statusIndicator.className = 'status-indicator offline';
                    statusText.textContent = 'Connection Failed';
                }
                
                // Exponential backoff for retries
                const retryDelay = Math.min(1000 * Math.pow(2, statusUpdateRetries), 30000);
                setTimeout(reportStatus, retryDelay);
            }
        }

        // Simple video player
        async function initPlayer() {
            try {
                // Use the configured video path
                const videoUrl = API_CONFIG.LOCAL_VIDEO;
                log(`Loading video: ${videoUrl}`, 'info');
                
                // Show loading state
                videoPlayer.style.display = 'none';
                
                // Set up video events
                videoPlayer.onloadeddata = () => {
                    videoPlayer.style.display = 'block';
                    log('Video loaded successfully', 'success');
                    videoPlayer.play()
                        .then(() => log('Video playback started', 'success'))
                        .catch(e => {
                            lastError = e.message;
                            log('Play error: ' + e.message, 'error');
                        });
                };
                
                videoPlayer.onerror = (e) => {
                    lastError = videoPlayer.error ? videoPlayer.error.message : 'Unknown error';
                    log('Video Error: ' + lastError, 'error');
                    // Try to load the video again after error
                    setTimeout(initPlayer, 5000);
                };
                
                // Load the video
                videoPlayer.src = videoUrl;
                
                // Monitor performance
                let lastTime = 0;
                videoPlayer.ontimeupdate = () => {
                    if (lastTime > 0) {
                        const diff = videoPlayer.currentTime - lastTime;
                        if (diff > 0.5) {
                            log('Frame skip detected', 'warning');
                        }
                    }
                    lastTime = videoPlayer.currentTime;
                };
            } catch (e) {
                lastError = e.message;
                log('Init error: ' + e.message, 'error');
                // Try to initialize again after error
                setTimeout(initPlayer, 5000);
            }
        }

        // Initialize
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();
        controls.style.display = 'block'; // Always show controls for debugging
        debugInfo.style.display = 'block'; // Always show debug during development

        // Start player
        initPlayer();
        
        // Set up status reporting interval with immediate first report
        reportStatus();
        setInterval(() => {
            if (Date.now() - lastStatusUpdate >= API_CONFIG.UPDATE_INTERVAL) {
                reportStatus();
            }
        }, 5000); // Check every 5 seconds

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'd') {
                debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
            }
        });

        // Prevent white flash during video loops
        videoPlayer.addEventListener('timeupdate', () => {
            if (videoPlayer.currentTime >= videoPlayer.duration - 0.1) {
                videoPlayer.currentTime = 0;
            }
        });

        // Show device ID when not paired
        if (!API_CONFIG.PAIRED) {
            const deviceIdElement = document.createElement('div');
            deviceIdElement.style.position = 'fixed';
            deviceIdElement.style.top = '10px';
            deviceIdElement.style.left = '10px';
            deviceIdElement.style.color = 'white';
            deviceIdElement.style.fontSize = '24px';
            deviceIdElement.style.fontWeight = 'bold';
            deviceIdElement.textContent = `Device ID: ${API_CONFIG.DEVICE_ID}`;
            document.body.appendChild(deviceIdElement);
        }
    </script>
</body>
</html>
